<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Résultats — DAAR</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

<div class="page-wrapper">

    <h1 class="montype">Résultats de la recherche</h1>

    <!-- BARRE DE RECHERCHE -->
    <div class="search-container" style="margin-bottom:30px; text-align:center;">
        <input type="text" id="searchInput" class="search-input"
            placeholder="Tape une recherche (texte ou RegEx)...">
        <button class="button search-button" id="searchBtn">Rechercher</button>
    </div>

    <!-- INDICATEUR DE PAGE -->
    <p id="page-indicator" style="text-align:center; font-size:18px; margin-top:-10px;"></p>

    <!-- RÉSULTATS -->
    <div id="results" class="results-grid">
        <p>Chargement...</p>
    </div>

    <!-- PAGINATION -->
    <div id="pagination" class="pagination"></div>

    <p class="button" onclick="window.location.href='findbooks.html'">Retour à la recherche</p>

</div>

<script>
const API_BASE = "http://127.0.0.1:8000";

function getParam(name) {
    return new URLSearchParams(window.location.search).get(name);
}

document.getElementById("searchBtn").onclick = () => {
    const q = document.getElementById("searchInput").value.trim();
    if (q) window.location.href = "results.html?q=" + encodeURIComponent(q) + "&page=1";
};

document.getElementById("searchInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") document.getElementById("searchBtn").click();
});

async function loadResults() {
    const q = getParam("q");
    const page = Number(getParam("page")) || 1;

    document.getElementById("searchInput").value = q ?? "";

    const res = await fetch(`${API_BASE}/search?q=${encodeURIComponent(q)}&page=${page}`);

    const container = document.getElementById("results");
    const indicator = document.getElementById("page-indicator");

    if (!res.ok) {
        container.innerHTML = "<p style='color:red'>Erreur lors du chargement.</p>";
        return;
    }

    const data = await res.json();
    const books = Array.isArray(data) ? data : data.results;

    if (!books || books.length === 0) {
        container.innerHTML = "<p>Aucun résultat trouvé.</p>";
        indicator.textContent = "";
        return;
    }

    container.innerHTML = "";
    indicator.textContent = `Page ${page}`;

    books.forEach(book => {
        // Récupération intelligente de la couverture
        let imgSrc;

        if (book.cover_url) {
            imgSrc = book.cover_url;
        } else {
            // couverture generée automatiquement
            imgSrc = `https://www.gutenberg.org/cache/epub/${book.doc_id}/pg${book.doc_id}.cover.medium.jpg`;
        }

        const card = document.createElement("div");
        card.className = "book-card";
        card.onclick = () => {
            window.location.href = `detail.html?id=${book.doc_id}`;
        };

        card.innerHTML = `
            <img src="${imgSrc}">
            <h3>${book.title}</h3>
            <p>${book.author ?? "Inconnu"}</p>
        `;

        container.appendChild(card);
    });

    // PAGINATION
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";

    // Nombre total de pages renvoyé par l’API
    const totalPages = data.total_pages;
    
    // Bouton Précédent
    if (page > 1) {
        const prev = document.createElement("button");
        prev.textContent = "Précédent";
        prev.onclick = () =>
            window.location.href = `results.html?q=${encodeURIComponent(q)}&page=${page - 1}`;
        pagination.appendChild(prev);
    }
    
    // Bouton Suivant
    if (page < totalPages) {
        const next = document.createElement("button");
        next.textContent = "Suivant";
        next.onclick = () =>
            window.location.href = `results.html?q=${encodeURIComponent(q)}&page=${page + 1}`;
        pagination.appendChild(next);
    }
    
}

loadResults();
</script>

</body>
</html>
