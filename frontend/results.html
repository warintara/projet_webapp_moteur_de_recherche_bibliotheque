<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>Résultats — DAAR Search</title>
</head>

<body>
    <h1 class="montype">Résultats de recherche</h1>

    <!-- on remet la barre de recherche en haut des résultats -->
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Tape une recherche ou une RegEx...">
        <button onclick="reloadSearch()">Search</button>
    </div>

    <div id="results" class="results-grid"></div>

    <div class="pagination">
        <button id="prevBtn">Précédent</button>
        <span id="pageInfo"></span>
        <button id="nextBtn">Suivant</button>
    </div>

    <p class="button" onclick="window.location.href='Index.html'">Go back to main page</p>

    <script>
        const PAGE_SIZE = 18;
        const API_BASE = "http://127.0.0.1:8000";

        let currentQuery = "";
        let currentPage = 1;

        function getParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        function looksLikeRegex(q) {
            // très simple mais suffisant pour DAAR
            return /[.*+?|()[\]\\]/.test(q);
        }

        async function loadPage() {
            currentQuery = getParam("q") || "";
            currentPage = parseInt(getParam("page") || "1", 10);

            document.getElementById("searchInput").value = currentQuery;

            const isRegex = looksLikeRegex(currentQuery);

            let url;
            if (isRegex) {
                url = `${API_BASE}/search_regex?pattern=${encodeURIComponent(currentQuery)}&page=${currentPage}&page_size=${PAGE_SIZE}`;
            } else {
                url = `${API_BASE}/search?q=${encodeURIComponent(currentQuery)}&page=${currentPage}&page_size=${PAGE_SIZE}`;
            }

            const res = await fetch(url);
            const data = await res.json();
            renderResults(data);
        }

        function renderResults(data) {
            const container = document.getElementById("results");
            container.innerHTML = "";

            const books = data.results || [];
            if (!books.length) {
                container.innerHTML = "<p>Aucun résultat trouvé.</p>";
                document.getElementById("pageInfo").textContent = "";
                return;
            }

            books.forEach(book => {
                const card = document.createElement("div");
                card.className = "book-card";

                const imgSrc = book.cover_image
                    ? `${API_BASE}${book.cover_image}`
                    : "https://via.placeholder.com/120x180?text=No+Cover";

                card.innerHTML = `
                    <img src="${imgSrc}" alt="cover">
                    <div class="book-title">${book.title || "(sans titre)"}</div>
                    <div class="book-meta"><strong>ID :</strong> ${book.doc_id}</div>
                    <div class="book-meta"><strong>Auteur :</strong> ${book.author || "Unknown author"}</div>
                `;

                container.appendChild(card);
            });

            const total = data.total_results ?? books.length;
            const nbPages = Math.max(1, Math.ceil(total / PAGE_SIZE));

            document.getElementById("pageInfo").textContent = `Page ${data.page} / ${nbPages}`;

            document.getElementById("prevBtn").disabled = (data.page <= 1);
            document.getElementById("nextBtn").disabled = (data.page >= nbPages);

            document.getElementById("prevBtn").onclick = () => changePage(data.page - 1);
            document.getElementById("nextBtn").onclick = () => changePage(data.page + 1);
        }

        function changePage(newPage) {
            const params = new URLSearchParams(window.location.search);
            params.set("page", newPage);
            window.location.search = params.toString();
        }

        function reloadSearch() {
            const q = document.getElementById("searchInput").value.trim();
            if (!q) return;
            const params = new URLSearchParams();
            params.set("q", q);
            params.set("page", "1");
            window.location.search = params.toString();
        }

        // premier chargement
        loadPage();
    </script>

</body>
</html>
